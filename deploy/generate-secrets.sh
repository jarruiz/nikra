#!/bin/bash
# ==============================================
# üîê GENERADOR DE SECRETS PARA RENDER
# ==============================================
# Este script genera autom√°ticamente todos los secrets necesarios
# para desplegar la aplicaci√≥n en Render de forma segura

set -e  # Salir si hay alg√∫n error

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Banner
echo -e "${BLUE}"
echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë                                                   ‚ïë"
echo "‚ïë   üîê  GENERADOR DE SECRETS PARA RENDER           ‚ïë"
echo "‚ïë       Nikra Backend - CCA Ceuta                  ‚ïë"
echo "‚ïë                                                   ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo -e "${NC}"
echo ""

# Verificar que Node.js est√° instalado
if ! command -v node &> /dev/null; then
    echo -e "${RED}‚ùå Error: Node.js no est√° instalado${NC}"
    echo "   Instala Node.js desde: https://nodejs.org"
    exit 1
fi

echo -e "${GREEN}‚úÖ Node.js detectado: $(node --version)${NC}"
echo ""

# Funci√≥n para generar un secret seguro
generate_secret() {
    local length=${1:-32}
    node -e "console.log(require('crypto').randomBytes($length).toString('hex'))"
}

# Funci√≥n para generar una contrase√±a legible pero segura
generate_password() {
    node -e "console.log(require('crypto').randomBytes(16).toString('base64').replace(/[^a-zA-Z0-9]/g, '').substring(0, 24))"
}

# Directorio de output (directorio actual)
OUTPUT_DIR="."
OUTPUT_FILE="$OUTPUT_DIR/.env.render"
OUTPUT_FILE_BACKUP="$OUTPUT_DIR/.env.render.backup"

# Crear backup si existe archivo previo
if [ -f "$OUTPUT_FILE" ]; then
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_FILE="$OUTPUT_DIR/.env.render.backup.$TIMESTAMP"
    echo -e "${YELLOW}‚ö†Ô∏è  Archivo existente detectado${NC}"
    echo "   Creando backup: $BACKUP_FILE"
    cp "$OUTPUT_FILE" "$BACKUP_FILE"
    echo ""
fi

echo -e "${BLUE}üîß Generando secrets seguros...${NC}"
echo ""

# Generar secrets
echo -n "   üîë Generando JWT_SECRET..."
JWT_SECRET=$(generate_secret 32)
echo -e " ${GREEN}‚úì${NC}"

echo -n "   üîë Generando JWT_REFRESH_SECRET..."
JWT_REFRESH_SECRET=$(generate_secret 32)
echo -e " ${GREEN}‚úì${NC}"

echo -n "   üóÑÔ∏è  Generando DB_PASSWORD..."
DB_PASSWORD=$(generate_password)
echo -e " ${GREEN}‚úì${NC}"

echo -n "   üë§ Generando DB_USERNAME..."
DB_USERNAME="nikra_user_$(node -e "console.log(require('crypto').randomBytes(4).toString('hex'))")"
echo -e " ${GREEN}‚úì${NC}"

echo ""
echo -e "${BLUE}üìù Generando archivo de configuraci√≥n...${NC}"

# Obtener timestamp
TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")

# Crear archivo .env.render con todos los valores
cat > "$OUTPUT_FILE" << EOF
# ==============================================
# üîê VARIABLES DE ENTORNO PARA RENDER
# ==============================================
# Generado autom√°ticamente: $TIMESTAMP
# ‚ö†Ô∏è  IMPORTANTE: Este archivo contiene secrets sensibles
# NO commitear este archivo a Git

# ==============================================
# üåç CONFIGURACI√ìN GENERAL
# ==============================================
NODE_ENV=production
PORT=3000

# ==============================================
# üóÑÔ∏è  BASE DE DATOS POSTGRESQL
# ==============================================
# Estos valores se configuran autom√°ticamente si usas Blueprint
# con render.yaml. Si configuras manualmente, usa estos valores:

DB_HOST=<render-proporcionar√°-esto>
DB_PORT=5432
DB_USERNAME=$DB_USERNAME
DB_PASSWORD=$DB_PASSWORD
DB_DATABASE=nikra_db

# ==============================================
# üîê JWT AUTHENTICATION
# ==============================================
# ‚ö†Ô∏è  CR√çTICO: Estos valores NUNCA deben compartirse p√∫blicamente

JWT_SECRET=$JWT_SECRET
JWT_EXPIRES_IN=15m
JWT_REFRESH_SECRET=$JWT_REFRESH_SECRET
JWT_REFRESH_EXPIRES_IN=7d

# ==============================================
# üåê CONFIGURACI√ìN OPCIONAL
# ==============================================
# Descomenta y configura seg√∫n necesites

# CORS_ORIGIN=https://tu-frontend.com
# MAX_FILE_SIZE=5242880
# UPLOAD_DIR=/app/uploads

# ==============================================
# üìä METADATA
# ==============================================
# Informaci√≥n del deployment

GENERATED_AT=$TIMESTAMP
GENERATED_BY=$(whoami)
DEPLOYMENT_ENV=production
EOF

echo ""
echo -e "${GREEN}‚úÖ Archivo generado exitosamente!${NC}"
echo ""

# Mostrar resumen
echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${BLUE}‚ïë                RESUMEN DE SECRETS                 ‚ïë${NC}"
echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
echo ""
echo -e "${YELLOW}üìÅ Archivo generado:${NC} $OUTPUT_FILE"
echo ""
echo -e "${GREEN}Secrets generados:${NC}"
echo "   ‚úì JWT_SECRET (64 caracteres)"
echo "   ‚úì JWT_REFRESH_SECRET (64 caracteres)"
echo "   ‚úì DB_PASSWORD (24 caracteres)"
echo "   ‚úì DB_USERNAME (√∫nico)"
echo ""

# Mostrar los valores (parcialmente ocultos por seguridad)
echo -e "${YELLOW}Vista previa de secrets (parcial):${NC}"
echo "   JWT_SECRET:         ${JWT_SECRET:0:8}...${JWT_SECRET: -8}"
echo "   JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:0:8}...${JWT_REFRESH_SECRET: -8}"
echo "   DB_USERNAME:        $DB_USERNAME"
echo "   DB_PASSWORD:        ${DB_PASSWORD:0:4}...${DB_PASSWORD: -4}"
echo ""

# Crear archivo de solo lectura para mayor seguridad
chmod 600 "$OUTPUT_FILE"
echo -e "${GREEN}üîí Permisos de seguridad aplicados (600)${NC}"
echo ""

# Generar archivo para copiar en Render UI
RENDER_VARS_FILE="./render-variables.txt"
cat > "$RENDER_VARS_FILE" << EOF
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
VARIABLES DE ENTORNO PARA RENDER - COPIA Y PEGA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Generado: $TIMESTAMP

Instrucciones:
1. Ve a tu servicio en Render Dashboard
2. Click en "Environment" en el men√∫ lateral
3. Copia y pega cada variable abajo

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

VARIABLES GENERALES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
NODE_ENV=production
PORT=3000

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BASE DE DATOS (Si configuras manualmente)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Nota: Si usas Blueprint con render.yaml, estas se autoconfiguran.
Solo necesitas configurar DB_USERNAME y DB_PASSWORD si creas
la base de datos manualmente.

DB_HOST=<desde-render-postgresql>
DB_PORT=5432
DB_USERNAME=$DB_USERNAME
DB_PASSWORD=$DB_PASSWORD
DB_DATABASE=nikra_db

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
JWT SECRETS (IMPORTANTE - CONFIGURA ESTOS MANUALMENTE)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
JWT_SECRET=$JWT_SECRET
JWT_EXPIRES_IN=15m
JWT_REFRESH_SECRET=$JWT_REFRESH_SECRET
JWT_REFRESH_EXPIRES_IN=7d

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

‚ö†Ô∏è  IMPORTANTE:
- Guarda estos valores en un lugar seguro (1Password, LastPass, etc.)
- NO los compartas por email, Slack, o documentos p√∫blicos
- NO los commitees a Git

‚úÖ PR√ìXIMOS PASOS:
1. Guarda estos valores en tu gestor de contrase√±as
2. Configura las variables en Render Dashboard
3. Despliega tu aplicaci√≥n
4. Ejecuta las migraciones: npm run migration:run

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
EOF

echo -e "${GREEN}üìã Archivo de variables para Render UI generado:${NC}"
echo "   $RENDER_VARS_FILE"
echo ""

# Generar script para configurar con Render CLI
RENDER_CLI_FILE="./configure-render-cli.sh"
cat > "$RENDER_CLI_FILE" << 'EOF_SCRIPT'
#!/bin/bash
# ==============================================
# üöÄ CONFIGURAR VARIABLES EN RENDER (usando CLI)
# ==============================================
# Este script configura las variables de entorno en Render
# usando la CLI de Render

set -e

# Cargar las variables generadas
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
if [ ! -f "$SCRIPT_DIR/.env.render" ]; then
    echo "‚ùå Error: Archivo .env.render no encontrado"
    echo "   Ejecuta primero: ./generate-secrets.sh"
    exit 1
fi

source "$SCRIPT_DIR/.env.render"

# Verificar que Render CLI est√° instalado
if ! command -v render &> /dev/null; then
    echo "‚ùå Render CLI no est√° instalado"
    echo ""
    echo "Instala con:"
    echo "  npm install -g @render/cli"
    echo ""
    exit 1
fi

# Solicitar el service ID
echo "üîç Necesitas el Service ID de tu servicio web en Render"
echo "   Puedes encontrarlo en la URL de tu servicio:"
echo "   https://dashboard.render.com/web/srv-XXXXXXXXXXXX"
echo ""
read -p "Service ID (srv-XXXXXXXXXXXX): " SERVICE_ID

if [ -z "$SERVICE_ID" ]; then
    echo "‚ùå Service ID es requerido"
    exit 1
fi

echo ""
echo "üöÄ Configurando variables de entorno en Render..."
echo ""

# Configurar variables usando Render CLI
render env set -s "$SERVICE_ID" NODE_ENV="$NODE_ENV"
render env set -s "$SERVICE_ID" PORT="$PORT"
render env set -s "$SERVICE_ID" JWT_SECRET="$JWT_SECRET"
render env set -s "$SERVICE_ID" JWT_EXPIRES_IN="$JWT_EXPIRES_IN"
render env set -s "$SERVICE_ID" JWT_REFRESH_SECRET="$JWT_REFRESH_SECRET"
render env set -s "$SERVICE_ID" JWT_REFRESH_EXPIRES_IN="$JWT_REFRESH_EXPIRES_IN"

echo ""
echo "‚úÖ Variables configuradas exitosamente!"
echo ""
echo "‚ÑπÔ∏è  Nota: Las variables de base de datos (DB_*) se configuran"
echo "   autom√°ticamente si usas Blueprint con render.yaml"
echo ""
echo "üîÑ Render redesplegar√° autom√°ticamente tu servicio"
echo ""
EOF_SCRIPT

chmod +x "$RENDER_CLI_FILE"

echo -e "${GREEN}üîß Script de configuraci√≥n CLI generado:${NC}"
echo "   $RENDER_CLI_FILE"
echo ""

# Instrucciones finales
echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${BLUE}‚ïë            PR√ìXIMOS PASOS                         ‚ïë${NC}"
echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
echo ""
echo -e "${YELLOW}1.${NC} Guarda los secrets en un lugar seguro:"
echo "   - 1Password, LastPass, Bitwarden, etc."
echo "   - Archivo: $OUTPUT_FILE"
echo ""
echo -e "${YELLOW}2.${NC} Configura las variables en Render:"
echo ""
echo -e "   ${GREEN}Opci√≥n A:${NC} Usando la UI de Render (Recomendado)"
echo "   - Abre: $RENDER_VARS_FILE"
echo "   - Copia las variables al Dashboard de Render"
echo ""
echo -e "   ${GREEN}Opci√≥n B:${NC} Usando Render CLI"
echo "   - Ejecuta: $RENDER_CLI_FILE"
echo ""
echo -e "${YELLOW}3.${NC} Despliega tu aplicaci√≥n en Render"
echo ""
echo -e "${YELLOW}4.${NC} Ejecuta las migraciones:"
echo "   render exec <tu-servicio> npm run migration:run"
echo ""
echo -e "${RED}‚ö†Ô∏è  SEGURIDAD:${NC}"
echo "   - NO commitees los archivos .env.render a Git"
echo "   - NO compartas los secrets p√∫blicamente"
echo "   - El archivo .gitignore ya est√° configurado"
echo ""
echo -e "${GREEN}‚ú® ¬°Listo! Tus secrets est√°n generados y seguros${NC}"
echo ""

